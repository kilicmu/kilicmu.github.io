<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="kilic">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Nginx+uWSGI+Django的部署过程"/>
  <meta property="og:description" content="咸鱼游民" />
  <meta property="og:site_name" content="kilic の 部落格"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://kilic.site"/>
  
    <link rel="alternate" href="/atom.xml" title="kilic の 部落格" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>kilic の 部落格</title>

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Custom CSS -->
  
  
<link rel="stylesheet" href="/css/style.dark.css">


  <!-- Google Analytics -->
  

<meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/m5.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Nginx+uWSGI+Django的部署过程</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/kilicmu">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:kilicmu3389@outlook.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By kilic</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2020-01-28</span>
            <span class="time">17:44:14</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/DJANGO/">#Django</a> <a class="tag" href="/tags/%E8%BF%90%E7%BB%B4/">#运维</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <p>由于最近在看node，很久没弄新东西了，拿以前的文章水一下 (,,•́ . •̀,,)</p>
<a id="more"></a>

<h2 id="1-创建一个nginx容器"><a href="#1-创建一个nginx容器" class="headerlink" title="1. 创建一个nginx容器:"></a>1. 创建一个nginx容器:</h2><p><code>docker run -id --name 容器名 -v django_project:/root/www/django_project -p 80:80 -p 443:443 nginx</code></p>
<h2 id="2-进入容器"><a href="#2-进入容器" class="headerlink" title="2. 进入容器:"></a>2. 进入容器:</h2><p><code>docker exec -it 容器名 /bin/bash</code></p>
<h2 id="3-安装net-tools与procps方便后期进行调试（可以不装）"><a href="#3-安装net-tools与procps方便后期进行调试（可以不装）" class="headerlink" title="3. 安装net-tools与procps方便后期进行调试（可以不装）"></a>3. 安装net-tools与procps方便后期进行调试（可以不装）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install net-tools</span><br><span class="line">apt install procps</span><br></pre></td></tr></table></figure>

<p>由于容器自带nginx, 所以我们只需要安装uwsgi即可:</p>
<h2 id="4-首先我们需要先了解一下一下WSGI"><a href="#4-首先我们需要先了解一下一下WSGI" class="headerlink" title="4. 首先我们需要先了解一下一下WSGI:"></a>4. 首先我们需要先了解一下一下WSGI:</h2><blockquote>
<p>WSGI(Web Server Gateway Interface) WSGI是一个规范，定义了Web服务器如何与Python应用程序进行交互，使得使用Python写的Web应用程序可以和Web服务器对接起来。</p>
<p>作为一个低级接口,WSGI就像是一座桥梁，一边连着web服务器(如 nginx)，另一边连着Python的应用程序Application。但是呢，这个桥的功能很弱，有时候还需要别的桥来帮忙才能进行处理。</p>
</blockquote>
<p>那么什么是uWSGI呢?</p>
<p>简单说, 他是一个实现了<strong>WSGI协议</strong>的一个web服务器</p>
<p>只要web服务器和web框架满足WSGI协议，它们就能相互搭配.</p>
<p>所以我们只需要使用uWSGI就可以满足我们对网站功能的使用, 那么我们为什么要使用nginx呢?</p>
<p>众所周知, nginx作为一款高性能的<a href="https://baike.baidu.com/item/HTTP">HTTP</a>和<a href="https://baike.baidu.com/item/反向代理/7793488">反向代理</a>web服务器, nginx可以解决高并发访问的负载问题, </p>
<p>当然我这破网站不可能有什么过大负载, 1G内存也不够开过多docker, 所以此处使用nginx更多是一种练习作用</p>
<p>我们可以让nginx负责静态资源的加载, nginx负责动态资源的访问</p>
<h2 id="5-接下来我们安装uWSGI"><a href="#5-接下来我们安装uWSGI" class="headerlink" title="5. 接下来我们安装uWSGI:"></a>5. 接下来我们安装uWSGI:</h2><p>首先确保容器内有pip3, 没有自行安装</p>
<p><code>apt install python3-pip</code></p>
<p>直接安装uwsgi</p>
<p><code>pip3 install uwsgi</code></p>
<h2 id="6-开始配置"><a href="#6-开始配置" class="headerlink" title="6. 开始配置:"></a>6. 开始配置:</h2><h3 id="6-1-在项目根目录创建uwsgi配置文件"><a href="#6-1-在项目根目录创建uwsgi配置文件" class="headerlink" title="6.1 在项目根目录创建uwsgi配置文件"></a>6.1 在项目根目录创建uwsgi配置文件</h3><p><code>vim uwsgi.ini</code></p>
<p>根据需求写入</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[uwsgi]</span></span><br><span class="line"><span class="attr">chdir</span> = your_project_dir</span><br><span class="line"><span class="attr">module</span> = your_project.wsgi:application <span class="comment">#此处的wsgi模块根据你的项目wsgi位置进行配置</span></span><br><span class="line"><span class="attr">master</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">processes</span> = <span class="number">4</span></span><br><span class="line"><span class="attr">max-requests</span> = <span class="number">5000</span></span><br><span class="line"><span class="attr">harakiri</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">socket</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8848</span>			<span class="comment">#设置监听端口</span></span><br><span class="line"><span class="attr">daemonize</span> =  your_project_dir/mysite.log	<span class="comment">#设置log位置</span></span><br><span class="line"><span class="attr">vacuum</span> = <span class="literal">True</span></span><br><span class="line"><span class="attr">threads</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">pidfile</span>=uwsgi.pid</span><br></pre></td></tr></table></figure>

<p>处理注释的地方, 其他的可以保持不变, 需要的话可以戳这里, 查看全部参数意义</p>
<h3 id="6-2开启一下"><a href="#6-2开启一下" class="headerlink" title="6.2开启一下:"></a>6.2开启一下:</h3><p><code>uwsgi --ini uwsgi.ini</code></p>
<p>出现这个提示就表示开启成功, 可以cat 一下.log查看日志</p>
<p><img src="http://note.youdao.com/yws/res/8320/WEBRESOURCE9b106dead1b9c7bedda83889782801e8" alt="img"></p>
<p>有的人可能会报这个错:Internal Server Error</p>
<p>可以检查一下自己的django项目是否有未安装的包存在, 只要包安装正确理论上就没有问题了</p>
<h3 id="6-3-配置nginx"><a href="#6-3-配置nginx" class="headerlink" title="6.3 配置nginx:"></a>6.3 配置nginx:</h3><p>在/etc/nginx/conf.d下新建一个自己的配置文件:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如: project.conf</span></span><br><span class="line"><span class="attr">upstream</span> <span class="string">django &#123;</span></span><br><span class="line"><span class="attr">\#</span> <span class="string">server unix:///path/to/your/mysite/mysite.sock; # for a file socket</span></span><br><span class="line"><span class="attr">server</span> <span class="string">127.0.0.1:8848;	//此处的端口是uwsgi监听的端口</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">listen</span>  <span class="string">80;  </span></span><br><span class="line"><span class="attr">server_name</span>  <span class="string">blog;  </span></span><br><span class="line"><span class="attr">charset</span> <span class="string">UTF-8;</span></span><br><span class="line"><span class="attr">client_max_body_size</span> <span class="string">75M;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="attr">uwsgi_pass</span> <span class="string">127.0.0.1:8848;</span></span><br><span class="line"><span class="attr">include</span> <span class="string">/etc/nginx/uwsgi_params;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/static &#123;				</span></span><br><span class="line"><span class="attr">alias</span> <span class="string">project_path/STATIC_URL;	#静态资源路(此处的STATIC_URL,需要替换为settings中的STATIC_URL, 下面的MEDIA_ROOT同</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/media &#123;</span></span><br><span class="line"><span class="attr">alias</span> <span class="string">project_path/MEDIA_ROOT; #上传资源路径</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="6-4-在nginx-conf中引入"><a href="#6-4-在nginx-conf中引入" class="headerlink" title="6.4 在nginx.conf中引入"></a>6.4 在nginx.conf中引入</h3><p><code>include /etc/nginx/conf.d/project.conf;</code></p>
<p><em>完成, 直接访问就可以了</em></p>
<h2 id="7-有兴趣可以继续配置https"><a href="#7-有兴趣可以继续配置https" class="headerlink" title="7. 有兴趣可以继续配置https"></a>7. 有兴趣可以继续配置https</h2><h3 id="7-1-首先获取个SSL证书"><a href="#7-1-首先获取个SSL证书" class="headerlink" title="7.1 首先获取个SSL证书:"></a>7.1 首先获取个SSL证书:</h3><p>阿里云的点这里:<a href="https://yundun.console.aliyun.com/?spm=5176.12901015.0.i12901015.1398525c1Nfqeu&amp;p=cas#/overview/cn-hangzhou">https://yundun.console.aliyun.com/?spm=5176.12901015.0.i12901015.1398525c1Nfqeu&amp;p=cas#/overview/cn-hangzhou</a></p>
<h3 id="7-2-然后把证书下载传到服务器-传到docker内部"><a href="#7-2-然后把证书下载传到服务器-传到docker内部" class="headerlink" title="7.2 然后把证书下载传到服务器, 传到docker内部"></a>7.2 然后把证书下载传到服务器, 传到docker内部</h3><p>解压</p>
<p>放到nginx配置目录(/etc/nginx/cert)目录下(没有cert目录自己创建)</p>
<p>配置刚才的project.conf</p>
<p>修改为以下:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">upstream</span> <span class="string">django &#123;</span></span><br><span class="line"><span class="attr">\#</span> <span class="string">server unix:///path/to/your/mysite/mysite.sock; # for a file socket</span></span><br><span class="line"><span class="attr">server</span> <span class="string">127.0.0.1:8848;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">listen</span> <span class="string">80;</span></span><br><span class="line"><span class="attr">server_name</span> <span class="string">kilic.site ;</span></span><br><span class="line"><span class="attr">rewrite</span> <span class="string">^(.*)$ https://$host$1 permanent;#自动转发https请求</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">listen</span>  <span class="string">443 ssl;  </span></span><br><span class="line"><span class="attr">server_name</span>  <span class="string">kilic.site;  </span></span><br><span class="line"><span class="attr">charset</span> <span class="string">UTF-8;</span></span><br><span class="line"><span class="attr">client_max_body_size</span> <span class="string">75M;</span></span><br><span class="line"><span class="attr">ssl_certificate</span> <span class="string">cert/xxx.pem;	#此处为自己的证书名</span></span><br><span class="line"><span class="attr">ssl_certificate_key</span> <span class="string">cert/xxx.key;	#此处为自己的私钥</span></span><br><span class="line"><span class="attr">ssl_ciphers</span> <span class="string">ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</span></span><br><span class="line"><span class="attr">ssl_protocols</span> <span class="string">TLSv1 TLSv1.1 TLSv1.2;</span></span><br><span class="line"><span class="attr">ssl_prefer_server_ciphers</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/ &#123;</span></span><br><span class="line"><span class="attr">uwsgi_pass</span> <span class="string">127.0.0.1:8848;</span></span><br><span class="line"><span class="attr">include</span> <span class="string">/etc/nginx/uwsgi_params;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/static &#123;</span></span><br><span class="line"><span class="attr">alias</span> <span class="string">/var/www/blog/static/;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">location</span> <span class="string">/media &#123;</span></span><br><span class="line"><span class="attr">alias</span> <span class="string">/var/www/blog/blog/media/;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>

<p>重启nginx:</p>
<p><code>nginx -s reload</code></p>
<p>以上!</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->

<script src="/js/highlight.pack.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

