<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="kilic">
  <!-- Open Graph Data -->
  <meta property="og:title" content="JWT原理与Nestjs的JWT方案"/>
  <meta property="og:description" content="咸鱼游民" />
  <meta property="og:site_name" content="kilic の 部落格"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://kilic.site"/>
  
    <link rel="alternate" href="/atom.xml" title="kilic の 部落格" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>kilic の 部落格</title>

  <!-- Bootstrap CSS -->
  
<link rel="stylesheet" href="/css/bootstrap.min.css">

  <!-- Custom CSS -->
  
  
<link rel="stylesheet" href="/css/style.dark.css">


  <!-- Google Analytics -->
  

<meta name="generator" content="Hexo 4.2.0"></head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/m5.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">JWT原理与Nestjs的JWT方案</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/kilicmu">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:kilicmu3389@outlook.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By kilic</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2020-06-12</span>
            <span class="time">17:44:14</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/NODEJS/">#nodejs</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h2 id="JWT认证"><a href="#JWT认证" class="headerlink" title="JWT认证"></a>JWT认证</h2><h3 id="JWT是什么？"><a href="#JWT是什么？" class="headerlink" title="JWT是什么？"></a>JWT是什么？</h3><p>JWT是JSON Web Token的简称，根据官网述说，它是一个开放标准（<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>），它定义了一种紧凑且自包含的方式，用于在各方之间作为JSON对象安全地传输信息。由于此信息是经过数字签名的，因此可以被验证和信任。</p>
<h3 id="应用场景？"><a href="#应用场景？" class="headerlink" title="应用场景？"></a>应用场景？</h3><ul>
<li><strong>授权</strong>：可以使用JWT作为登录后的请求认证，它的请求开销小且可以实现分布请求。</li>
<li><strong>信息交换</strong>：使用JWT可以在各方之间安全地传输信息。可以对JWT进行签名，验证信息是否被修改。</li>
</ul>
<h3 id="JWT特点"><a href="#JWT特点" class="headerlink" title="JWT特点"></a>JWT特点</h3><ul>
<li>体积小</li>
<li>请求方式多样（GET/POST/HTTP-Header）</li>
<li>结构化，可携带信息</li>
<li>实现单点登录与跨域验证</li>
</ul>
<h3 id="JWT原理"><a href="#JWT原理" class="headerlink" title="JWT原理"></a>JWT原理</h3><p>JWT由以下结构组成：</p>
<p><code>header.payload.secret</code></p>
<ol>
<li>标头（header【base64后】）</li>
<li>有效荷载（payload【base64后】）</li>
<li>签名（secret）</li>
</ol>
<h4 id="header"><a href="#header" class="headerlink" title="header"></a>header</h4><p>包含加密算法与类别：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	'alg': 'HS256',</span><br><span class="line">    'typ': 'JWT'</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后将头部进行base64加密，构成了第一部分：</p>
<p><code>ewogICAgJ2FsZyc6ICdIUzI1NicsCiAgICAndHlwJzogJ0pXVCcKfQ==</code></p>
<h4 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h4><p>payload可以看做有效数据的存储区域，这些信息包好三个部分：</p>
<ul>
<li>标准中的注册声明</li>
<li>公共的声明</li>
<li>私有的声明</li>
</ul>
<h5 id="标准中的注册声明"><a href="#标准中的注册声明" class="headerlink" title="标准中的注册声明"></a>标准中的注册声明</h5><p>声明名称仅是三个字符，因为JWT是紧凑的，他们都是可选的：</p>
<ul>
<li>iss：该JWT的签发者</li>
<li>iat(issued at)：在什么时候签发的，UNIX时间戳</li>
<li>exp(expires): 什么时候过期，这里是一个UNIX时间戳</li>
<li>aud：接收该JWT的一方</li>
<li>sub：该JWT所面向的用户（userid）</li>
<li>nbf (Not Before)：如果当前时间在nbf里的时间之前，则Token不被接受</li>
<li>jti：jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击。</li>
</ul>
<h5 id="公共的声明"><a href="#公共的声明" class="headerlink" title="公共的声明"></a>公共的声明</h5><p>公共的声明可以添加任何的非敏感信息（base64可逆），可以用来携带业务信息或用户信息。</p>
<h5 id="私有的声明"><a href="#私有的声明" class="headerlink" title="私有的声明"></a>私有的声明</h5><p>私有声明是提供者和消费者所共同定义的声明。</p>
<h5 id="举个例子："><a href="#举个例子：" class="headerlink" title="举个例子："></a>举个例子：</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="attr">"scopes"</span>: [ <span class="string">"admin"</span>, <span class="string">"user"</span> ] </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>做一下base64加密：<code>ewogICJzdWIiOiAiMTIzNDU2Nzg5MCIsCiAgIm5hbWUiOiAiSm9obiBEb2UiLAogICJzY29wZXMiOiBbICJhZG1pbiIsICJ1c2VyIiBdIAp9</code></p>
<h4 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h4><p>要创建签名部分，您必须获取编码的标头，编码的有效载荷，标头中指定的算法，并对其进行签名。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">"."</span> +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const encodedString &#x3D; base64UrlEncode(header) + &#39;.&#39; + base64UrlEncode(payload);</span><br><span class="line">const signature &#x3D; HMACSHA256(encodedString, &#39;secret&#39;);</span><br></pre></td></tr></table></figure>

<h4 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h4><p>输出是三个由点分隔的Base64-URL字符串，可以在HTML和HTTP环境中轻松传递这些字符串，与基于XML的标准（例如SAML）相比，它更紧凑。可以在<a href="https://jwt.io/#debugger-io">这里</a>解码，验证与生产JWT。</p>
<h3 id="JWT验证流程"><a href="#JWT验证流程" class="headerlink" title="JWT验证流程"></a>JWT验证流程</h3><p><img src="https://i.niupic.com/images/2020/06/12/8ghr.png" alt="JWT使用流程"></p>
<ol>
<li><p>用户请求登录服务器</p>
</li>
<li><p>服务器接到请求生成一个jwt-token</p>
</li>
<li><p>把这个jwt-token发回到前端</p>
</li>
<li><p>每次请求的时候带这个token和uid</p>
</li>
<li><p>收到jwt-token首先比较对不对，完后用secret解密后再次比较内部信息对不对，是否被更改过。</p>
</li>
<li><p>认证通过就可以请求别的接口返回对应的response了</p>
</li>
</ol>
<h2 id="Nestjs配置JWT认证"><a href="#Nestjs配置JWT认证" class="headerlink" title="Nestjs配置JWT认证"></a>Nestjs配置JWT认证</h2><p>以下内容需要有一定的Nestjs基础，有Spring Boot的基础可以很快上手：<a href="https://nestjs.com/">Nestjs文档</a></p>
<p>个人感觉Nestjs开发比Spring爽很多，生态肯定是被Spring完爆，但是满足企业级快速开发是绰绰有余的，前端可以了解一下。</p>
<p>下面我们来说使用Nestjs做JWT认证方案：</p>
<h3 id="passport"><a href="#passport" class="headerlink" title="passport"></a>passport</h3><p>passport是一个nodejs认证库，他可以使用在许多的生成应用中，Nestjs可以与passport做很好的集成。</p>
<h3 id="认证策略"><a href="#认证策略" class="headerlink" title="认证策略"></a>认证策略</h3><p>我们需要两种策略：</p>
<ul>
<li>用户名/密码身份验证机制(login)</li>
<li>Token身份验证(限制资源获取)</li>
</ul>
<p>passport提供了两种包实现这种策略：</p>
<ul>
<li>passport-local</li>
<li>passport-jwt</li>
</ul>
<p>我们需要安装这些包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add @nestjs/passport passport passport-local @nestjs/jwt passport-jwt</span><br><span class="line">yarn add @types/passport-local @types/passport-jwt -D</span><br></pre></td></tr></table></figure>

<p>对于不同的规则，有不同的实现，所以我们需要有两套策略的实现</p>
<p><img src="https://i.niupic.com/images/2020/06/13/8gqB.png" alt="文件目录"></p>
<p>我们分别看一下这两种策略的实现:</p>
<p>local-auth.guard.ts:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable, UnauthorizedException, Request &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Strategy &#125; <span class="keyword">from</span> <span class="string">'passport-local'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ModuleRef, ContextIdFactory &#125; <span class="keyword">from</span> <span class="string">'@nestjs/core'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> LocalStrategy <span class="keyword">extends</span> PassportStrategy(Strategy) &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly authService: AuthService</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validate(username: <span class="built_in">string</span>, password: <span class="built_in">string</span>, request: Request): <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.authService.validateUser(username, password);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>authService.validateUser是对登录验证的模拟，我们会在后面讲解</p>
<p>jwt.strategy.ts:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">'./../../common/constants/contants'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Strategy &#125; <span class="keyword">from</span> <span class="string">'passport-jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportStrategy &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; ExtractJwt &#125; <span class="keyword">from</span> <span class="string">'passport-jwt'</span>;</span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> JwtStrategy <span class="keyword">extends</span> PassportStrategy(Strategy) &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>(&#123;</span><br><span class="line">      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(), <span class="comment">// 提供从请求中提取 JWT 的方法</span></span><br><span class="line">      ignoreExpiration: <span class="literal">false</span>, <span class="comment">// 确保 JWT 没有过期的责任委托给 Passport 模块</span></span><br><span class="line">      secretOrKey: jwtConstants.secret, <span class="comment">//提供对称的秘钥来签署令牌</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validate(payload: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; userId: payload.sub, username: payload.username &#125;;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，我们需要提供一个秘钥来做jwt的加密，所以我们可以将这个常量提取放入jwtConstants中为一个单独文件。此处省略那个步骤。</p>
<p>接下来我们需要两种守卫限制路由的权限。</p>
<p><img src="https://i.niupic.com/images/2020/06/13/8gqC.png" alt="守卫文件"></p>
<p>他们分别继承自AuthGuard(‘local’)与AuthGuard(‘jwt’)，你可以直接使用他们作为守卫，但是为了扩展性和可读性，我们将他们提取出来。</p>
<p>local=auth.guard.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> LocalAuthGurad <span class="keyword">extends</span> AuthGuard(<span class="string">'local'</span>)&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>jwt-auth.guard.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Injectable, ExecutionContext, UnauthorizedException &#125; <span class="keyword">from</span> <span class="string">"@nestjs/common"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthGuard &#125; <span class="keyword">from</span> <span class="string">"@nestjs/passport"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> JwtAuthGuard <span class="keyword">extends</span> AuthGuard(<span class="string">'jwt'</span>) &#123;</span><br><span class="line">  canActivate(context: ExecutionContext):<span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="comment">// 在这里添加自定义的认证逻辑</span></span><br><span class="line">    <span class="comment">// 例如调用 super.logIn(request) 来建立一个session</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.canActivate(context);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleRequest(err, user, info):<span class="built_in">any</span> &#123;</span><br><span class="line">    <span class="comment">// 可以抛出一个基于info或者err参数的异常</span></span><br><span class="line">    <span class="keyword">if</span> (err || !user) &#123;</span><br><span class="line">      <span class="keyword">throw</span> err || <span class="keyword">new</span> UnauthorizedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以通过继承自定义验证逻辑。</p>
<p>通过service我们可以实现所有的主要逻辑，包括验证用户与token签发</p>
<p>auth-service.ts</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; UsersService &#125; <span class="keyword">from</span> <span class="string">'../users/users.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtService &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Injectable &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> IUser &#123;</span><br><span class="line">  username: <span class="built_in">string</span>;</span><br><span class="line">  userId: <span class="built_in">number</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthService &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> readonly usersService: UsersService,</span></span><br><span class="line"><span class="params">    <span class="keyword">private</span> readonly jwtService: JwtService,</span></span><br><span class="line"><span class="params">  </span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> validateUser(username: <span class="built_in">string</span>, pass: <span class="built_in">string</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> <span class="keyword">this</span>.usersService.findOne(username);</span><br><span class="line">    <span class="keyword">if</span> (user &amp;&amp; user.password === pass) &#123;</span><br><span class="line">      <span class="comment">// bcrypt 密码加密</span></span><br><span class="line">      <span class="keyword">const</span> &#123; password, ...result &#125; = user;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> login(user: IUser): <span class="built_in">Promise</span>&lt;&#123; access_token: <span class="built_in">string</span> &#125;&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> payload = &#123; username: user.username, sub: user.userId &#125;;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      access_token: <span class="keyword">this</span>.jwtService.sign(payload), <span class="comment">//返回带有payload的token</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处使用validateUser来模拟密码验证，login模拟token的签发。</p>
<p>然后为Passport模块做一下配置：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; JwtStrategy &#125; <span class="keyword">from</span> <span class="string">'./jwt.strategy'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; jwtConstants &#125; <span class="keyword">from</span> <span class="string">'./../../common/constants/contants'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/jwt'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LocalStrategy &#125; <span class="keyword">from</span> <span class="string">'./local.strategy'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; UsersModule &#125; <span class="keyword">from</span> <span class="string">'../users/users.module'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Module &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AuthController &#125; <span class="keyword">from</span> <span class="string">'./auth.controller'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; PassportModule &#125; <span class="keyword">from</span> <span class="string">'@nestjs/passport'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Module</span>(&#123;</span><br><span class="line">  imports: [</span><br><span class="line">    UsersModule,</span><br><span class="line">    PassportModule.register(&#123;defaultStrategy: <span class="string">'jwt'</span>&#125;), <span class="comment">//配置默认的策略（JWT），默认策略可以不用指定策略</span></span><br><span class="line">    JwtModule.register(&#123;</span><br><span class="line">    secret: jwtConstants.secret,</span><br><span class="line">    signOptions: &#123; expiresIn: <span class="string">'60s'</span> &#125;,<span class="comment">//失效时间</span></span><br><span class="line">    &#125;),</span><br><span class="line">  ],</span><br><span class="line">  controllers: [AuthController],</span><br><span class="line">  providers: [AuthService, LocalStrategy, JwtStrategy],</span><br><span class="line">  exports: [AuthService],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthModule &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>使用controller模拟路由逻辑即可：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; AuthService &#125; <span class="keyword">from</span> <span class="string">'./auth.service'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Controller, UseGuards, Post, Request, Get &#125; <span class="keyword">from</span> <span class="string">'@nestjs/common'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; LocalAuthGurad &#125; <span class="keyword">from</span> <span class="string">'src/common/guards/local-auth.guard'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; JwtAuthGuard &#125; <span class="keyword">from</span> <span class="string">'src/common/guards/jwt-auth.guard'</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span>(<span class="string">'auth'</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> AuthController &#123;</span><br><span class="line">  <span class="keyword">constructor</span>(<span class="params"><span class="keyword">private</span> readonly authService: AuthService</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(LocalAuthGurad)</span><br><span class="line">  <span class="meta">@Post</span>(<span class="string">'login'</span>)</span><br><span class="line">  <span class="keyword">async</span> login(<span class="meta">@Request</span>() req: <span class="built_in">any</span>): <span class="built_in">Promise</span>&lt;<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.authService.login(req.user);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@UseGuards</span>(JwtAuthGuard)</span><br><span class="line">  <span class="meta">@Get</span>(<span class="string">'profile'</span>)</span><br><span class="line">  getProfile(<span class="meta">@Request</span>() req: <span class="built_in">any</span>) &#123; <span class="comment">//这里不能使用异步</span></span><br><span class="line">    <span class="keyword">return</span> req.user;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>token获取：</p>
<p><img src="https://i.niupic.com/images/2020/06/13/8gqP.png" alt="token获取"></p>
<p>token验证：</p>
<p><img src="https://i.niupic.com/images/2020/06/13/8gqO.png" alt="token验证"></p>
<p>以上！</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->

<script src="/js/highlight.pack.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

